<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MyStudy - æ™‚é–“é †ToDo</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <a href="home.html" class="logo" style="text-decoration: none; color: inherit;">ğŸ“˜ MyStudy</a>
    <div class="menu-button" onclick="toggleMenu()">â˜°</div>
  </header>

  <nav id="dropdown-menu" class="menu">
    <a href="home.html">ğŸ  ãƒ›ãƒ¼ãƒ </a>
    <a href="todo.html">ğŸ•’ æ™‚é–“é †è¡¨ç¤º</a>
    <a href="#" onclick="addClass()">â• æ•™ç§‘ã‚’è¿½åŠ </a>
  </nav>

  <main>
    <div class="card">
      <div class="card-header">
        <h2>ğŸ•’ ä»Šæ—¥ä»¥é™ã®ToDoãƒ»ã‚¤ãƒ™ãƒ³ãƒˆ</h2>
        <select id="filterSelect" onchange="filterEntries()">
          <option value="all">ã™ã¹ã¦</option>
          <option value="todo">ToDoã®ã¿</option>
          <option value="event">ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿</option>
        </select>
      </div>
      <div id="sorted-list"></div>
      <p id="empty-message" style="display: none;">ğŸ“­ ä»Šæ—¥ä»¥é™ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</p>
    </div>
  </main>

  <footer class="bottom-nav">
    <a href="home.html">ğŸ </a>
    <a href="todo.html">ğŸ•’</a>
    <a href="#" onclick="addClass()">â•</a>
  </footer>

  <!-- å…±é€šã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script src="addClass.js"></script>
  <script src="utils.js"></script>

  <script>
    const classes = JSON.parse(localStorage.getItem("classes") || "[]");
    let todos = JSON.parse(localStorage.getItem("todos") || "[]");
    let events = JSON.parse(localStorage.getItem("events") || "[]");
    const today = new Date().toISOString().split("T")[0];

    const entries = [];

    todos.forEach(t => {
      if (!t.done && t.due >= today) {
        const className = classes.find(c => c.id === t.classId)?.subject || "æ•™ç§‘ãªã—";
        const isoTime = t.time ? `${t.due}T${t.time}` : t.due;
        entries.push({
          id: t.id,
          type: "todo",
          iso: isoTime,
          label: `[ToDo] (${className})ï¼š${t.content}${t.memo ? `ï¼ˆ${t.memo}ï¼‰` : ''}`
        });
      }
    });

    events.forEach(e => {
      if (e.date >= today) {
        const className = classes.find(c => c.id === e.classId)?.subject || "";
        const isoTime = e.time ? `${e.date}T${e.time}` : e.date;
        entries.push({
          id: e.id,
          type: "event",
          iso: isoTime,
          label: `[ã‚¤ãƒ™ãƒ³ãƒˆ] ${className ? `${className}ï¼š` : ''}${e.title}${e.memo ? `ï¼ˆ${e.memo}ï¼‰` : ''}`
        });
      }
    });

    entries.sort((a, b) => new Date(a.iso) - new Date(b.iso));

    function filterEntries() {
      const type = document.getElementById("filterSelect").value;
      const list = document.getElementById("sorted-list");
      const emptyMessage = document.getElementById("empty-message");
      list.innerHTML = "";

      const filtered = entries.filter(e => type === "all" || e.type === type);

      if (filtered.length === 0) {
        emptyMessage.style.display = "block";
      } else {
        emptyMessage.style.display = "none";
        filtered.forEach(e => {
          const div = document.createElement("div");
          div.className = "item";

          const d = new Date(e.iso);
          const dateStr = `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}` +
                          `${e.iso.length > 10 ? ` ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}` : ''}`;

          div.innerHTML = `<time>${dateStr}</time><div>${e.label}</div>`;

          const btn = document.createElement("button");
          btn.textContent = "å‰Šé™¤";
          btn.onclick = () => deleteEntry(e.type, e.id);  // â† å…±é€šé–¢æ•°ä½¿ç”¨
          div.appendChild(btn);
          list.appendChild(div);
        });
      }
    }

    filterEntries();
  </script>
</body>
</html>
