<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MyStudy - æ™‚é–“é †ToDo</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <a href="home.html" class="logo" style="text-decoration: none; color: inherit;">ğŸ“˜ MyStudy</a>
    <div class="menu-button" onclick="toggleMenu()">â˜°</div>
  </header>

  <nav id="dropdown-menu" class="menu"></nav>

  <main>
    <div class="card">
      <div class="card-header">
        <h2>ğŸ•’ ä»Šæ—¥ä»¥é™ã®äºˆå®š</h2>
        <select id="filterSelect" onchange="filterEntries()" style="width: auto;">
          <option value="all">ã™ã¹ã¦</option>
          <option value="todo">ToDoã®ã¿</option>
          <option value="event">ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿</option>
        </select>
      </div>
      <div id="sorted-list"></div>
      <p id="empty-message" style="display: none;">ğŸ“­ ä»Šæ—¥ä»¥é™ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</p>
    </div>
  </main>

  <footer class="bottom-nav">
    <a href="home.html">ğŸ </a>
    <a href="todo.html">ğŸ•’</a>
    <a href="#" onclick="addClass()">â•</a>
  </footer>

  <script src="utils.js"></script>
  <script>
    injectEditModal();

    const classes = JSON.parse(localStorage.getItem("classes") || "[]");
    let todos   = JSON.parse(localStorage.getItem("todos")  || "[]");
    let events  = JSON.parse(localStorage.getItem("events") || "[]");

    // æœŸé™åˆ‡ã‚Œå‰Šé™¤ï¼ˆæ°¸ç¶šåŒ–ï¼‰
    const cleaned = removeExpiredEntries(todos, events);
    todos  = cleaned.todos;
    events = cleaned.events;

    // â‘  å…ƒãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ entries ã‚’çµ„ã¿ç«‹ã¦
    const entries = [];
    todos.forEach(t => {
      if (!t.done) {
        entries.push({
          id:     t.id,
          type:   "todo",
          time:   getDateTime(t.due, t.time).getTime(),
          dateStr: formatEntryDate(t.due, t.time),
          label:  t.content,
          memo:   t.memo  || "",
          subject: classes.find(c => c.id===t.classId)?.subject || ""
        });
      }
    });
    events.forEach(e => {
      entries.push({
        id:     e.id,
        type:   "event",
        time:   getDateTime(e.date, e.time).getTime(),
        dateStr: formatEntryDate(e.date, e.time),
        label:  e.title,
        memo:   e.memo  || "",
        subject: classes.find(c => c.id===e.classId)?.subject || ""
      });
    });

    // â‘¡ ä»Šæ—¥ä»¥é™ã®ã‚‚ã®ã ã‘ã‚’æŠ½å‡ºã—ã¤ã¤ã€æ™‚é–“é †ã«ã‚½ãƒ¼ãƒˆ
    const now = Date.now();
    const visibleEntries = entries
      .filter(e => e.time >= now)
      .sort((a, b) => a.time - b.time);

    // â‘¢ ãƒ•ã‚£ãƒ«ã‚¿ï¼†æç”»é–¢æ•°
    function filterEntries() {
      const type = document.getElementById("filterSelect").value;
      const list = document.getElementById("sorted-list");
      const empty = document.getElementById("empty-message");
      list.innerHTML = "";

      const filtered = visibleEntries.filter(e =>
        type === "all" || e.type === type
      );

      if (filtered.length === 0) {
        empty.style.display = "block";
      } else {
        empty.style.display = "none";
        filtered.forEach(e => {
          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = 
            `<time>${e.dateStr}</time>` +
            `<div>[${e.type==='todo'?'ToDo':'ã‚¤ãƒ™ãƒ³ãƒˆ'}] ` +
              `${e.subject ? e.subject+'ï¼š':''}${e.label}` +
              `${e.memo    ? `ï¼ˆ${e.memo}ï¼‰` : ''}` +
            `</div>`;

          const editBtn = document.createElement("button");
          editBtn.textContent = "ç·¨é›†";
          editBtn.onclick = () => openEditModal(e.type, e.id);
          div.appendChild(editBtn);

          const delBtn = document.createElement("button");
          delBtn.textContent = "å‰Šé™¤";
          delBtn.onclick = () => deleteEntry(e.type, e.id);
          div.appendChild(delBtn);

          list.appendChild(div);
        });
      }
    }

    // æœ€åˆã®æç”»
    filterEntries();
  </script>
</body>
</html>